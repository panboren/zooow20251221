# taichi.js å®Œæ•´çŸ¥è¯†æ€»ç»“

## ğŸ“š ä¸€ã€taichi.js ç®€ä»‹

taichi.js æ˜¯ä¸€ä¸ªåŸºäº TypeScript/JavaScript çš„é«˜æ€§èƒ½ GPU å¹¶è¡Œè®¡ç®—æ¡†æ¶ï¼Œä½¿ç”¨ WebGPU åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ GPU åŠ é€Ÿè®¡ç®—ã€‚

### æ ¸å¿ƒç‰¹ç‚¹
- ğŸš€ **GPU å¹¶è¡Œè®¡ç®—** - åˆ©ç”¨æ˜¾å¡åŠ é€Ÿ
- ğŸŒ **æµè§ˆå™¨åŸç”Ÿè¿è¡Œ** - æ— éœ€åç«¯
- ğŸ“ **Python é£æ ¼è¯­æ³•** - æ˜“äºç†è§£
- ğŸ¨ **æ”¯æŒå›¾å½¢æ¸²æŸ“å’Œç§‘å­¦è®¡ç®—**

---

## ğŸ”§ äºŒã€å®‰è£…ä¸é…ç½®

### 2.1 å®‰è£…
```bash
npm install taichi.js
```

### 2.2 Nuxt æ’ä»¶é…ç½®
```typescript
// plugins/taichi.client.ts
export default defineNuxtPlugin({
  name: 'taichi',
  setup(nuxtApp) {
    nuxtApp.provide('loadTaichi', async () => {
      return await import('/taichi.js-master/dist/taichi.js')
    })
  }
})
```

### 2.3 åŠ è½½ taichi.js
```typescript
// åœ¨ Vue ç»„ä»¶ä¸­
const { $loadTaichi } = useNuxtApp()
const ti = await $loadTaichi()
await ti.init()
```

---

## ğŸ—„ï¸ ä¸‰ã€æ ¸å¿ƒæ•°æ®ç»“æ„ï¼šField

### 3.1 ä»€ä¹ˆæ˜¯ Fieldï¼Ÿ
Field æ˜¯ taichi.js çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œç±»ä¼¼äºæ•°ç»„ï¼Œä½†åœ¨ GPU ä¸Šå­˜å‚¨å’Œè®¿é—®ã€‚

### 3.2 åˆ›å»ºæ ‡é‡ Field
```typescript
// ä¸€ç»´æ•°ç»„
const arr = ti.field(ti.i32, [100])

// äºŒç»´æ•°ç»„
const matrix = ti.field(ti.f32, [512, 512])

// ä¸‰ç»´æ•°ç»„
const volume = ti.field(ti.f32, [100, 100, 100])
```

### 3.3 åˆ›å»ºå‘é‡ Field
```typescript
// RGBA é¢œè‰²ï¼ˆ4 åˆ†é‡ï¼‰
const pixels = ti.Vector.field(4, ti.f32, [512, 512])

// XY åæ ‡ï¼ˆ2 åˆ†é‡ï¼‰
const positions = ti.Vector.field(2, ti.f32, [1000])

// XYZ å‘é‡ï¼ˆ3 åˆ†é‡ï¼‰
const vectors = ti.Vector.field(3, ti.f32, [100])
```

### 3.4 åˆ›å»ºçŸ©é˜µ Field
```typescript
// 2x2 çŸ©é˜µ
const matrices = ti.Matrix.field(2, 2, ti.f32, [100])

// 3x3 çŸ©é˜µ
const transforms = ti.Matrix.field(3, 3, ti.f32, [50])
```

### 3.5 æ•°æ®ç±»å‹
| ç±»å‹ | è¯´æ˜ |
|------|------|
| `ti.i32` | 32ä½æ•´æ•° |
| `ti.f32` | 32ä½æµ®ç‚¹æ•° |
| `ti.i64` | 64ä½æ•´æ•° |
| `ti.f64` | 64ä½æµ®ç‚¹æ•° |

---

## âš¡ å››ã€Kernelï¼ˆå†…æ ¸ï¼‰

### 4.1 ä»€ä¹ˆæ˜¯ Kernelï¼Ÿ
Kernel æ˜¯åœ¨ GPU ä¸Šå¹¶è¡Œæ‰§è¡Œçš„å‡½æ•°ï¼Œå¯ä»¥åŒæ—¶å¤„ç†å¤§é‡æ•°æ®ã€‚

### 4.2 åˆ›å»º Kernel
```typescript
// åŸºæœ¬è¯­æ³•
const kernel = ti.kernel(function k() {
  // GPU å¹¶è¡Œä»£ç 
})

// å‘½åå‡½æ•°ï¼ˆæ¨èï¼‰
const kernel = ti.kernel(function fillArray() {
  for (let i of range(100)) {
    arr[i] = i * 2
  }
})
```

### 4.3 range() å‡½æ•°
```typescript
// ä» 0 åˆ° n-1
for (let i of range(100)) {
  // i = 0, 1, 2, ..., 99
}

// åµŒå¥—å¾ªç¯ï¼ˆäºŒç»´æ•°ç»„ï¼‰
for (let i of range(512)) {
  for (let j of range(512)) {
    // éå† 512x512
  }
}
```

### 4.4 æ‰§è¡Œ Kernel
```typescript
kernel()  // ç®€å•æ‰§è¡Œ

// Kernel æ˜¯å¼‚æ­¥çš„ï¼Œä½†è°ƒç”¨æ–¹å¼æ˜¯åŒæ­¥çš„
kernel()
const result = await arr.toArray1D()  // æ‰§è¡Œåè¯»å–æ•°æ®
```

---

## ğŸ”— äº”ã€addToKernelScope - å†…æ ¸ä½œç”¨åŸŸ

### 5.1 ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ
Kernel å‡½æ•°éœ€è¦çŸ¥é“å¯ä»¥è®¿é—®å“ªäº› Field å’Œå‡½æ•°ã€‚

### 5.2 ä½¿ç”¨æ–¹æ³•
```typescript
// åˆ›å»º Field
const arr = ti.field(ti.i32, [100])

// æ·»åŠ åˆ°å†…æ ¸ä½œç”¨åŸŸ
ti.addToKernelScope({ arr })

// å®šä¹‰è¾…åŠ©å‡½æ•°
const helper = function helper(x) {
  return x * 2
}

// æ·»åŠ å‡½æ•°åˆ°ä½œç”¨åŸŸ
ti.addToKernelScope({ arr, helper })

// åœ¨ kernel ä¸­ä½¿ç”¨
const kernel = ti.kernel(function k() {
  for (let i of range(100)) {
    arr[i] = helper(i)  // âœ… å¯ä»¥è®¿é—®
  }
})
```

### 5.3 å¸¸è§é”™è¯¯
```typescript
// âŒ é”™è¯¯ï¼šå¿˜è®°æ·»åŠ åˆ°ä½œç”¨åŸŸ
const arr = ti.field(ti.i32, [100])
const kernel = ti.kernel(function k() {
  arr[i] = i  // é”™è¯¯ï¼šunresolved identifier
})

// âœ… æ­£ç¡®
ti.addToKernelScope({ arr })
const kernel = ti.kernel(function k() {
  arr[i] = i  // âœ… æ­£ç¡®
})
```

---

## ğŸ¨ å…­ã€Canvas æ¸²æŸ“

### 6.1 åˆ›å»º Canvas
```typescript
// HTML
<canvas ref="canvasEl" width="512" height="512"></canvas>

// JavaScript
const tiCanvas = new ti.Canvas(canvasEl.value)
```

### 6.2 æ˜¾ç¤ºå›¾åƒ
```typescript
// æ˜¾ç¤º Field åˆ° Canvas
await tiCanvas.setImage(pixels)
```

### 6.3 æ³¨æ„äº‹é¡¹
- **Field æ ¼å¼**ï¼šå¿…é¡»æ˜¯äºŒç»´çš„ Vector field
- **å‘é‡ç»´åº¦**ï¼šé€šå¸¸æ˜¯ 4 (RGBA) æˆ– 3 (RGB)
- **æ•°æ®èŒƒå›´**ï¼šé¢œè‰²å€¼å¿…é¡»æ˜¯ 0.0-1.0 çš„æµ®ç‚¹æ•°

```typescript
// âœ… æ­£ç¡®æ ¼å¼
const pixels = ti.Vector.field(4, ti.f32, [512, 512])

// âŒ é”™è¯¯æ ¼å¼
const pixels = ti.field(ti.f32, [512, 512, 4])  // ä¸‰ç»´æ— æ³•æ¸²æŸ“
```

---

## ğŸ› ä¸ƒã€è°ƒè¯•æŠ€å·§

### 7.1 âŒ ä¸æ”¯æŒçš„æ“ä½œ
```typescript
const kernel = ti.kernel(function k() {
  console.log(i)  // âŒ ä¸æ”¯æŒ
  debugger        // âŒ ä¸æ”¯æŒ
  alert(i)        // âŒ ä¸æ”¯æŒ
})
```

### 7.2 è°ƒè¯•æ–¹æ³• 1ï¼šç‰¹æ®Šå€¼æ ‡è®°
```typescript
const arr = ti.field(ti.i32, [100])

const kernel = ti.kernel(function k() {
  for (let i of range(100)) {
    if (i === 50) {
      arr[i] = 9999  // ç”¨ç‰¹æ®Šå€¼æ ‡è®°
    } else {
      arr[i] = i
    }
  }
})

kernel()
const result = await arr.toArray1D()
console.log('arr[50] =', result[50])
```

### 7.3 è°ƒè¯•æ–¹æ³• 2ï¼šè°ƒè¯• Field
```typescript
const arr = ti.field(ti.i32, [100])
const debugLog = ti.field(ti.i32, [10])

ti.addToKernelScope({ arr, debugLog })

const kernel = ti.kernel(function k() {
  for (let i of range(100)) {
    arr[i] = i * 2
    if (i < 10) {
      debugLog[i] = i  // è®°å½•å…³é”®ç‚¹
    }
  }
})

kernel()
const logs = await debugLog.toArray1D()
console.log('è°ƒè¯•ä¿¡æ¯:', logs)
```

### 7.4 è°ƒè¯•æ–¹æ³• 3ï¼šå¯è§†åŒ–
```typescript
const kernel = ti.kernel(function k() {
  for (let i of range(512)) {
    for (let j of range(512)) {
      let value = i * j
      if (value < 10000) {
        pixels[[i, j]] = [1, 0, 0, 1]  // çº¢è‰²
      } else if (value < 20000) {
        pixels[[i, j]] = [0, 1, 0, 1]  // ç»¿è‰²
      } else {
        pixels[[i, j]] = [0, 0, 1, 1]  // è“è‰²
      }
    }
  }
})
```

---

## âš ï¸ å…«ã€è¯­æ³•é™åˆ¶

### 8.1 âŒ ä¸æ”¯æŒçš„è¯­æ³•

#### 1. ä¸‰å…ƒè¿ç®—ç¬¦
```typescript
// âŒ é”™è¯¯
const result = condition ? value1 : value2

// âœ… æ­£ç¡®
let result
if (condition) {
  result = value1
} else {
  result = value2
}
```

#### 2. return è¯­å¥ï¼ˆåœ¨å¾ªç¯/åˆ†æ”¯ä¸­ï¼‰
```typescript
// âŒ é”™è¯¯
const fn = function f(x) {
  if (x > 0) {
    return 1.0
  }
  return 0.0
}

// âœ… æ­£ç¡®
const fn = function f(x) {
  let result
  if (x > 0) {
    result = 1.0
  } else {
    result = 0.0
  }
  return result  // åªèƒ½åœ¨å‡½æ•°æœ«å°¾è¿”å›
}
```

#### 3. è§£æ„èµ‹å€¼
```typescript
// âŒ é”™è¯¯
const [a, b] = array

// âœ… æ­£ç¡®
const a = array[0]
const b = array[1]
```

#### 4. æŸäº› Math å‡½æ•°
```typescript
// âŒ å¯èƒ½ä¸æ”¯æŒ
const min = Math.min(a, b, c)
const abs = Math.abs(x)

// âœ… æ‰‹åŠ¨å®ç°
let min = a
if (b < min) {
  min = b
}
if (c < min) {
  min = c
}

let abs = x
if (abs < 0) {
  abs = -abs
}
```

### 8.2 âœ… æ”¯æŒçš„è¯­æ³•

#### åŸºæœ¬è¿ç®—
```typescript
// ç®—æœ¯
const sum = a + b
const diff = a - b

// æ¯”è¾ƒ
const isEqual = a == b
const isGreater = a > b

// é€»è¾‘
const and = a && b
const or = a || b
```

#### æ¡ä»¶è¯­å¥
```typescript
if (condition) {
  // æ‰§è¡Œ
}

if (condition) {
  // æ‰§è¡Œ
} else {
  // å¦åˆ™
}
```

#### å¾ªç¯
```typescript
for (let i of range(n)) {
  // å¾ªç¯ä½“
}

while (condition) {
  // å¾ªç¯ä½“
}
```

---

## ğŸ”¢ ä¹ã€ç±»å‹ç³»ç»Ÿ

### 9.1 ç±»å‹æ¨æ–­
taichi.js ä¼šæ ¹æ®å€¼è‡ªåŠ¨æ¨æ–­ç±»å‹ï¼š
```typescript
const a = 5      // æ•´æ•°
const b = 5.0    // æµ®ç‚¹æ•°
const c = i       // å¦‚æœ i æ˜¯æ•´æ•°ï¼Œc ä¹Ÿæ˜¯æ•´æ•°
```

### 9.2 ç±»å‹è½¬æ¢
```typescript
// æ•´æ•°è½¬æµ®ç‚¹æ•°
const i = 10
const f = i * 1.0  // è½¬æ¢ä¸ºæµ®ç‚¹æ•°

// æ‰€æœ‰æ•°å­—ä½¿ç”¨æµ®ç‚¹æ•°ä»¥é¿å…ç±»å‹é”™è¯¯
const v0 = [256.0, 50.0]  // æµ®ç‚¹æ•°
const x = i * 1.0           // è½¬æ¢ä¸ºæµ®ç‚¹æ•°
```

### 9.3 ç±»å‹é”™è¯¯ç¤ºä¾‹
```typescript
// âŒ é”™è¯¯ï¼šç±»å‹ä¸åŒ¹é…
let alpha = 0      // æ•´æ•°
alpha = 1.0 - x   // æµ®ç‚¹æ•°èµ‹å€¼ç»™æ•´æ•°

// âœ… æ­£ç¡®
let alpha = 0.0    // æµ®ç‚¹æ•°
alpha = 1.0 - x    // æµ®ç‚¹æ•°èµ‹å€¼ç»™æµ®ç‚¹æ•°
```

---

## ğŸ¯ åã€å›¾å½¢æ¸²æŸ“ç¤ºä¾‹

### 10.1 æ¸å˜èƒŒæ™¯
```typescript
const kernel = ti.kernel(function k() {
  for (let i of range(512)) {
    for (let j of range(512)) {
      const r = i / 511.0
      const g = j / 511.0
      const b = 0.5
      pixels[[i, j]] = [r, g, b, 1.0]
    }
  }
})
```

### 10.2 ä¸‰è§’å½¢æ£€æµ‹
```typescript
const triangleEdgeFunction = function edge(x, y, ax, ay, bx, by) {
  return (bx - ax) * (y - ay) - (by - ay) * (x - ax)
}

const kernel = ti.kernel(function k() {
  const v0 = [256.0, 50.0]
  const v1 = [50.0, 400.0]
  const v2 = [462.0, 400.0]

  for (let i of range(512)) {
    for (let j of range(512)) {
      const x = i * 1.0
      const y = j * 1.0

      const w0 = triangleEdgeFunction(x, y, v1[0], v1[1], v2[0], v2[1])
      const w1 = triangleEdgeFunction(x, y, v2[0], v2[1], v0[0], v0[1])
      const w2 = triangleEdgeFunction(x, y, v0[0], v0[1], v1[0], v1[1])

      const inside = (w0 >= 0.0 && w1 >= 0.0 && w2 >= 0.0) ||
                   (w0 <= 0.0 && w1 <= 0.0 && w2 <= 0.0)

      if (inside) {
        pixels[[i, j]] = [1.0, 1.0, 0.0, 1.0]  // é»„è‰²
      }
    }
  }
})
```

### 10.3 åœ†å½¢æ£€æµ‹
```typescript
const kernel = ti.kernel(function k() {
  const cx = 256.0, cy = 256.0, radius = 100.0

  for (let i of range(512)) {
    for (let j of range(512)) {
      const x = i * 1.0
      const y = j * 1.0

      const dx = x - cx
      const dy = y - cy
      const distanceSquared = dx * dx + dy * dy

      if (distanceSquared < radius * radius) {
        pixels[[i, j]] = [0.0, 0.0, 1.0, 1.0]  // è“è‰²
      }
    }
  }
})
```

---

## ğŸ“Š åä¸€ã€åæ ‡ç³»ç»Ÿ

### 11.1 åƒç´ åæ ‡
```typescript
for (let i of range(512)) {   // i: 0-511 (xè½´ï¼Œæ¨ªå‘)
  for (let j of range(512)) { // j: 0-511 (yè½´ï¼Œçºµå‘)
    pixels[[i, j]] = color
  }
}
```

### 11.2 åæ ‡å¯¹åº”
- `(0, 0)` â†’ å·¦ä¸Šè§’
- `(511, 0)` â†’ å³ä¸Šè§’
- `(0, 511)` â†’ å·¦ä¸‹è§’
- `(511, 511)` â†’ å³ä¸‹è§’
- `(256, 256)` â†’ ä¸­å¿ƒ

---

## ğŸ¨ åäºŒã€é¢œè‰²è¡¨ç¤º

### 12.1 RGBA æ ¼å¼
```typescript
// æ ¼å¼: [çº¢, ç»¿, è“, alpha]
pixels[[i, j]] = [r, g, b, a]

// èŒƒå›´: 0.0 - 1.0
const black = [0.0, 0.0, 0.0, 1.0]
const white = [1.0, 1.0, 1.0, 1.0]
const red = [1.0, 0.0, 0.0, 1.0]
const green = [0.0, 1.0, 0.0, 1.0]
const blue = [0.0, 0.0, 1.0, 1.0]
const yellow = [1.0, 1.0, 0.0, 1.0]
```

### 12.2 é¢œè‰²æ··åˆ
```typescript
const alpha = 0.5
const color1 = [1.0, 0.0, 0.0, 1.0]  // çº¢è‰²
const color2 = [0.0, 0.0, 1.0, 1.0]  // è“è‰²

// æ··åˆ
const mixed_r = color1[0] * alpha + color2[0] * (1.0 - alpha)
const mixed_g = color1[1] * alpha + color2[1] * (1.0 - alpha)
const mixed_b = color1[2] * alpha + color2[2] * (1.0 - alpha)

pixels[[i, j]] = [mixed_r, mixed_g, mixed_b, 1.0]
```

---

## ğŸš€ åä¸‰ã€æ€§èƒ½ä¼˜åŒ–

### 13.1 å¹¶è¡Œæ‰§è¡Œ
taichi.js è‡ªåŠ¨å°† range å¾ªç¯å¹¶è¡ŒåŒ–åˆ° GPU ä¸Šã€‚

### 13.2 é¿å…æ¡ä»¶åˆ†æ”¯
è¿‡å¤šçš„ if-else ä¼šå½±å“ GPU æ€§èƒ½ï¼š
```typescript
// âŒ å·®ï¼šå¤§é‡æ¡ä»¶
if (i === 0) {
  // ...
} else if (i === 1) {
  // ...
} else if (i === 2) {
  // ...
}

// âœ… å¥½ï¼šä½¿ç”¨æ•°ç»„æŸ¥æ‰¾
const results = [val0, val1, val2, val3]
const value = results[i]
```

### 13.3 å†…å­˜è®¿é—®æ¨¡å¼
è¿ç»­è®¿é—®æ›´é«˜æ•ˆï¼š
```typescript
// âœ… å¥½ï¼šè¿ç»­è®¿é—®
for (let i of range(512)) {
  arr[i] = i
}

// âŒ å·®ï¼šéšæœºè®¿é—®
arr[randomIndex()] = value
```

---

## ğŸ” åå››ã€å¸¸è§é”™è¯¯ä¸è§£å†³

### 14.1 unresolved identifier
```typescript
// é”™è¯¯
const arr = ti.field(ti.i32, [100])
const kernel = ti.kernel(function k() {
  arr[i] = i
})

// è§£å†³
ti.addToKernelScope({ arr })
```

### 14.2 ç±»å‹é”™è¯¯
```typescript
// é”™è¯¯
let x = 0
x = 1.0

// è§£å†³
let x = 0.0
x = 1.0
```

### 14.3 ä¸‰å…ƒè¿ç®—ç¬¦é”™è¯¯
```typescript
// é”™è¯¯
const a = condition ? 1.0 : 0.0

// è§£å†³
let a
if (condition) {
  a = 1.0
} else {
  a = 0.0
}
```

---

## ğŸ“ åäº”ã€æœ€ä½³å®è·µ

### 15.1 å‘½åè§„èŒƒ
```typescript
// Field: æè¿°æ€§åç§°
const pixels = ti.Vector.field(4, ti.f32, [512, 512])
const positions = ti.Vector.field(2, ti.f32, [1000])

// Kernel: åŠ¨è¯å¼€å¤´
const fillImage = ti.kernel(function fillImage() { })
const computeForces = ti.kernel(function computeForces() { })

// è¾…åŠ©å‡½æ•°: æè¿°åŠŸèƒ½
const isPointInCircle = function isPointInCircle(x, y) { }
const mixColors = function mixColors(c1, c2) { }
```

### 15.2 ä»£ç ç»„ç»‡
```typescript
// 1. åˆ›å»º Field
const pixels = ti.Vector.field(4, ti.f32, [512, 512])

// 2. å®šä¹‰è¾…åŠ©å‡½æ•°
const helper = function helper(x) { }

// 3. æ·»åŠ åˆ°ä½œç”¨åŸŸ
ti.addToKernelScope({ pixels, helper })

// 4. åˆ›å»º Kernel
const kernel = ti.kernel(function k() { })

// 5. æ‰§è¡Œ Kernel
kernel()

// 6. è¯»å–ç»“æœ
const result = await pixels.toArray1D()

// 7. æ˜¾ç¤º
await tiCanvas.setImage(pixels)
```

### 15.3 è°ƒè¯•å‹å¥½
```typescript
// ä½¿ç”¨æ¸…æ™°çš„é¢œè‰²åŒºåˆ†ä¸åŒåŒºåŸŸ
if (condition1) {
  pixels[[i, j]] = [1, 0, 0, 1]  // çº¢è‰²
} else if (condition2) {
  pixels[[i, j]] = [0, 1, 0, 1]  // ç»¿è‰²
} else if (condition3) {
  pixels[[i, j]] = [0, 0, 1, 1]  // è“è‰²
} else {
  pixels[[i, j]] = [0.5, 0.5, 0.5, 1]  // ç°è‰²
}
```

---

## ğŸ“ åå…­ã€å­¦ä¹ è·¯å¾„

### åˆçº§
1. âœ… å®‰è£…å’Œåˆå§‹åŒ–
2. âœ… åˆ›å»ºç®€å• Field
3. âœ… ç¼–å†™åŸºç¡€ Kernel
4. âœ… ä½¿ç”¨ range å¾ªç¯
5. âœ… æ˜¾ç¤ºåˆ° Canvas

### ä¸­çº§
1. âœ… å‘é‡å’ŒçŸ©é˜µæ“ä½œ
2. âœ… åµŒå¥—å¾ªç¯
3. âœ… æ¡ä»¶è¯­å¥
4. âœ… æ•°å­¦å‡½æ•°
5. âœ… è°ƒè¯•æŠ€å·§

### é«˜çº§
1. âœ… å¤šä¸ª kernel åä½œ
2. âœ… çº¹ç†æ“ä½œ
3. âœ… 3D æ¸²æŸ“
4. âœ… æ€§èƒ½ä¼˜åŒ–
5. âœ… å®é™…é¡¹ç›®åº”ç”¨

---

è¿™å°±æ˜¯ taichi.js çš„å®Œæ•´çŸ¥è¯†æ€»ç»“ï¼æŒæ¡è¿™äº›çŸ¥è¯†ç‚¹ï¼Œä½ å°±å¯ä»¥å¼€å§‹ä½¿ç”¨ taichi.js è¿›è¡Œ GPU åŠ é€Ÿè®¡ç®—äº†ï¼ğŸš€
