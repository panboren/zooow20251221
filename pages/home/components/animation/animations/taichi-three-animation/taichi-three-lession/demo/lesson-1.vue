<template>
  <div class="lesson-page">
    <div class="content-area">
      <div class="lesson-info">
        <div class="lesson-header">
          <h2>ç¬¬1è¯¾ï¼šHello World - è®¤è¯† Taichi.js</h2>
          <span class="lesson-tag">å…¥é—¨</span>
        </div>

        <div class="section">
          <h3>ğŸ“š å­¦ä¹ ç›®æ ‡</h3>
          <ul>
            <li>ç†è§£ Taichi.js çš„åŸºæœ¬æ¦‚å¿µ</li>
            <li>å­¦ä¹  @ti.kernel è£…é¥°å™¨</li>
            <li>äº†è§£å­—æ®µç³»ç»Ÿï¼ˆField Systemï¼‰</li>
            <li>åˆ›å»ºç¬¬ä¸€ä¸ª GPU è®¡ç®—ç¨‹åº</li>
          </ul>
        </div>

        <div class="section">
          <h3>ğŸ¯ Taichi.js æ˜¯ä»€ä¹ˆï¼Ÿ</h3>
          <p>
            Taichi.js æ˜¯ä¸€ä¸ªç°ä»£çš„ GPU è®¡ç®—æ¡†æ¶ï¼Œå®ƒå°† JavaScript å‡½æ•°è½¬æ¢ä¸º WebGPU Compute Shaderï¼Œ
            å®ç°å¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—ã€‚å®ƒæ˜¯ Python ç‰ˆ Taichi çš„ JavaScript ç§»æ¤ç‰ˆã€‚
          </p>
          <div class="highlight-box">
            <strong>æ ¸å¿ƒç‰¹ç‚¹ï¼š</strong>
            <ul>
              <li>âš¡ åˆ©ç”¨ GPU è¿›è¡Œå¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—</li>
              <li>ğŸ”§ å°† JS ä»£ç è‡ªåŠ¨è½¬æ¢ä¸º Compute Shader</li>
              <li>ğŸ“¦ ç®€æ´çš„è¯­æ³•ï¼Œç±»ä¼¼ Python Taichi</li>
              <li>ğŸŒ åŸºäº WebGPUï¼Œæ”¯æŒç°ä»£æµè§ˆå™¨</li>
            </ul>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ“– æ ¸å¿ƒæ¦‚å¿µ</h3>
          <div class="concept-card">
            <h4>1. @ti.kernelï¼ˆè®¡ç®—å†…æ ¸ï¼‰</h4>
            <p>
              <code>@ti.kernel</code> è£…é¥°çš„å‡½æ•°ä¼šåœ¨ GPU ä¸Šå¹¶è¡Œæ‰§è¡Œã€‚
              æ¯ä¸ªå…ƒç´ çš„è®¡ç®—éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå¯ä»¥åŒæ—¶å¤„ç†æˆåƒä¸Šä¸‡ä¸ªæ•°æ®ã€‚
            </p>
            <pre><code>// Taichi.js è®¡ç®—å†…æ ¸ç¤ºä¾‹
let kernel = ti.kernel((n) => {
  for (let i = 0; i < n; i++) {
    // è¿™é‡Œçš„å¾ªç¯ä¼šè¢« GPU å¹¶è¡Œæ‰§è¡Œ
    result[i] = i * i
  }
})</code></pre>
          </div>

          <div class="concept-card">
            <h4>2. å­—æ®µï¼ˆFieldï¼‰</h4>
            <p>
              å­—æ®µæ˜¯ Taichi.js ä¸­çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå­˜å‚¨åœ¨ GPU æ˜¾å­˜ä¸­ã€‚
              å¯ä»¥æ˜¯ä¸€ç»´ã€äºŒç»´ã€ä¸‰ç»´æ•°ç»„ï¼Œæ”¯æŒæ ‡é‡ã€å‘é‡ã€çŸ©é˜µç­‰ç±»å‹ã€‚
            </p>
            <pre><code>// åˆ›å»ºå­—æ®µ
let scalarField = ti.field(ti.f32, [100])           // 1D æ ‡é‡å­—æ®µ
let vectorField = ti.Vector.field(3, ti.f32, [100]) // 1D å‘é‡å­—æ®µ
let matrixField = ti.Matrix.field(2, 2, ti.f32, [50]) // 2D çŸ©é˜µå­—æ®µ</code></pre>
          </div>

          <div class="concept-card">
            <h4>3. æ•°æ®ç±»å‹</h4>
            <p>Taichi.js æ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼š</p>
            <ul>
              <li><code>ti.f32</code> - 32ä½æµ®ç‚¹æ•°ï¼ˆæœ€å¸¸ç”¨ï¼‰</li>
              <li><code>ti.i32</code> - 32ä½æ•´æ•°</li>
              <li><code>ti.Vector</code> - å‘é‡ç±»å‹</li>
              <li><code>ti.Matrix</code> - çŸ©é˜µç±»å‹</li>
            </ul>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ’» ä»£ç æ¼”ç¤º</h3>
          <div class="code-demo">
            <h4>ç¤ºä¾‹ï¼šè®¡ç®—å¹³æ–¹æ•°</h4>
            <pre><code>// 1. åˆå§‹åŒ– Taichi.js
await ti.init()

// 2. åˆ›å»ºå­—æ®µï¼ˆGPU æ•°æ®ï¼‰
const n = 1000
const result = ti.field(ti.f32, [n])

// 3. æ·»åŠ åˆ°å†…æ ¸ä½œç”¨åŸŸ
ti.addToKernelScope({ result, n })

// 4. åˆ›å»ºè®¡ç®—å†…æ ¸
const computeSquares = ti.kernel(() => {
  for (let i = 0; i < n; i++) {
    result[i] = i * i
  }
})

// 5. æ‰§è¡Œå†…æ ¸
computeSquares()

// 6. è¯»å–ç»“æœ
for (let i = 0; i < 10; i++) {
  console.log(`result[${i}] = ${result[i]}`)
}</code></pre>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ§ª äº’åŠ¨æ¼”ç¤º</h3>
          <div class="demo-container">
            <div class="demo-controls">
              <label>
                æ•°æ®é‡ N:
                <input type="range" v-model.number="demoN" min="100" max="10000" step="100" />
                {{ demoN }}
              </label>
              <button @click="runDemo" :disabled="isRunning">
                {{ isRunning ? 'è¿è¡Œä¸­...' : 'è¿è¡Œæ¼”ç¤º' }}
              </button>
              <button @click="clearResult">æ¸…é™¤ç»“æœ</button>
            </div>
            <div class="demo-result">
              <h4>æ‰§è¡Œç»“æœ</h4>
              <div class="result-stats">
                <p>çŠ¶æ€: <span :class="statusClass">{{ status }}</span></p>
                <p>æ‰§è¡Œæ—¶é—´: {{ executionTime.toFixed(2) }}ms</p>
                <p>è®¡ç®—ç»“æœï¼ˆå‰10ä¸ªï¼‰:</p>
              </div>
              <div class="result-values">
                <span v-for="(val, idx) in displayResults" :key="idx" class="result-value">
                  result[{{ idx }}] = {{ val }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸš€ ä¸‹ä¸€æ­¥</h3>
          <p>å®Œæˆæœ¬è¯¾åï¼Œæ‚¨å°†äº†è§£ï¼š</p>
          <ul>
            <li>âœ… Taichi.js çš„åŸºæœ¬æ¦‚å¿µå’Œä¼˜åŠ¿</li>
            <li>âœ… å¦‚ä½•åˆ›å»ºå’Œä½¿ç”¨å­—æ®µ</li>
            <li>âœ… å¦‚ä½•ç¼–å†™è®¡ç®—å†…æ ¸</li>
          </ul>
          <p class="next-lesson">
            ä¸‹ä¸€è¯¾å°†å­¦ä¹  Three.js åŸºç¡€åœºæ™¯æ­å»ºï¼Œä¸ºåç»­çš„åä½œæ‰“ä¸‹åŸºç¡€ã€‚
          </p>
        </div>
      </div>

      <div class="navigation">
        <button class="nav-btn prev" disabled>
          â† ä¸Šä¸€è¯¾
        </button>
        <button class="nav-btn next" @click="goToNext">
          ç¬¬2è¯¾ï¼šThree.js åŸºç¡€åœºæ™¯æ­å»º â†’
        </button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'

// æ¼”ç¤ºå‚æ•°
const demoN = ref(1000)
const isRunning = ref(false)
const status = ref('å°±ç»ª')
const executionTime = ref(0)
const results = ref<number[]>([])

const statusClass = computed(() => {
  if (status.value === 'è¿è¡ŒæˆåŠŸ') return 'success'
  if (status.value === 'è¿è¡Œå¤±è´¥') return 'error'
  return 'idle'
})

const displayResults = computed(() => {
  return results.value.slice(0, 10)
})

async function runDemo() {
  isRunning.value = true
  status.value = 'åˆå§‹åŒ– Taichi.js...'
  results.value = []

  try {
    // å°è¯•åˆå§‹åŒ– Taichi.js
    let ti: any = null
    
    // æ£€æŸ¥å…¨å±€ ti
    if ((window as any).ti) {
      ti = (window as any).ti
      await ti.init()
    } else {
      // å°è¯•åŠ¨æ€å¯¼å…¥
      const taichiModule = await import('taichi.js')
      ti = taichiModule
      await ti.init()
    }

    status.value = 'åˆ›å»ºå­—æ®µ...'
    const n = demoN.value

    // åˆ›å»ºå­—æ®µ - ä½¿ç”¨ ti.f32 ä½œä¸ºç±»å‹
    const result = ti.field(ti.f32, [n])
    ti.addToKernelScope({ result, n })

    status.value = 'åˆ›å»ºå†…æ ¸...'
    const computeSquares = ti.kernel(() => {
      // ä½¿ç”¨ ti.range è¿›è¡Œä¸€ç»´å¾ªç¯ï¼ˆå‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼‰
      for (let i of ti.range(n)) {
        // ç›´æ¥èµ‹å€¼ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ¨æ–­ç±»å‹
        result[i] = i * i
      }
    })

    status.value = 'GPU è®¡ç®—ä¸­...'
    const start = performance.now()

    // æ‰§è¡Œå†…æ ¸
    await computeSquares()

    // è¯»å–ç»“æœ - ä½¿ç”¨ toArray ä» GPU è¯»å–æ•°æ®åˆ° CPU
    const allResults = await result.toArray()
    const output = allResults.slice(0, 10)

    executionTime.value = performance.now() - start
    results.value = output
    status.value = 'è¿è¡ŒæˆåŠŸ'
    
  } catch (error) {
    console.error('è¿è¡Œå¤±è´¥:', error)
    status.value = 'è¿è¡Œå¤±è´¥: ' + error
  }

  isRunning.value = false
}

function clearResult() {
  results.value = []
  status.value = 'å°±ç»ª'
  executionTime.value = 0
}

function goToNext() {
  alert('å³å°†è·³è½¬åˆ°ç¬¬2è¯¾ï¼šThree.js åŸºç¡€åœºæ™¯æ­å»º')
  // TODO: å®ç°è·³è½¬
}
</script>

<style scoped lang="scss">
.lesson-page {
  min-height: 100vh;
  background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
  padding: 80px 30px 30px 30px;
  color: white;
}

.content-area {
  max-width: 900px;
  margin: 0 auto;
}

.lesson-info {
  .lesson-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;

    h2 {
      margin: 0;
      font-size: 32px;
      color: #00ff88;
    }

    .lesson-tag {
      padding: 6px 15px;
      background: rgba(0, 255, 136, 0.2);
      border: 1px solid rgba(0, 255, 136, 0.4);
      border-radius: 20px;
      font-size: 13px;
      color: #00ff88;
    }
  }

  .section {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(255, 255, 255, 0.08);

    h3 {
      margin: 0 0 15px 0;
      font-size: 22px;
      color: #00aaff;
    }

    p {
      font-size: 15px;
      line-height: 1.7;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 15px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;

      li {
        padding: 8px 0 8px 25px;
        position: relative;
        font-size: 15px;
        line-height: 1.6;
        color: rgba(255, 255, 255, 0.85);

        &:before {
          content: 'â–¸';
          position: absolute;
          left: 0;
          color: #00ff88;
        }
      }
    }
  }

  .highlight-box {
    background: rgba(255, 200, 0, 0.1);
    border-left: 4px solid rgba(255, 200, 0, 0.6);
    padding: 15px 20px;
    border-radius: 8px;
    margin: 20px 0;

    strong {
      color: #ffc800;
      font-size: 16px;
    }

    ul {
      li {
        &:before {
          color: #ffc800;
        }
      }
    }
  }

  .concept-card {
    background: rgba(0, 50, 100, 0.2);
    border: 1px solid rgba(0, 170, 255, 0.2);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;

    h4 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: #88ccff;
    }

    p {
      margin-bottom: 10px;
    }

    pre {
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 10px 0;

      code {
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.5;
        color: #aaffaa;
      }
    }
  }

  .code-demo {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(0, 255, 136, 0.2);
    border-radius: 12px;
    padding: 20px;

    h4 {
      margin: 0 0 15px 0;
      font-size: 16px;
      color: #00ff88;
    }

    pre {
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;

      code {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.6;
        color: #aaffaa;
      }
    }
  }

  .demo-container {
    background: rgba(0, 50, 100, 0.15);
    border: 1px solid rgba(0, 170, 255, 0.2);
    border-radius: 12px;
    padding: 25px;

    .demo-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;

      label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;

        input[type="range"] {
          cursor: pointer;
        }
      }

      button {
        padding: 10px 20px;
        background: rgba(0, 255, 136, 0.2);
        border: 1px solid rgba(0, 255, 136, 0.4);
        border-radius: 8px;
        color: #00ff88;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;

        &:hover:not(:disabled) {
          background: rgba(0, 255, 136, 0.3);
        }

        &:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }
      }
    }

    .demo-result {
      h4 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #88ccff;
      }

      .result-stats {
        p {
          font-size: 14px;
          margin-bottom: 8px;

          .success {
            color: #00ff88;
            font-weight: bold;
          }

          .error {
            color: #ff4444;
            font-weight: bold;
          }

          .idle {
            color: rgba(255, 255, 255, 0.7);
          }
        }
      }

      .result-values {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;

        .result-value {
          padding: 8px 12px;
          background: rgba(0, 170, 255, 0.2);
          border-radius: 6px;
          font-size: 13px;
          font-family: 'Courier New', monospace;
          color: #a0a0ff;
        }
      }
    }
  }

  .next-lesson {
    padding: 15px;
    background: rgba(0, 255, 136, 0.1);
    border-left: 3px solid #00ff88;
    border-radius: 6px;
    font-style: italic;
    color: rgba(255, 255, 255, 0.8);
  }
}

.navigation {
  display: flex;
  justify-content: space-between;
  margin-top: 30px;

  .nav-btn {
    padding: 12px 25px;
    background: rgba(0, 170, 255, 0.2);
    border: 1px solid rgba(0, 170, 255, 0.3);
    border-radius: 8px;
    color: #00aaff;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;

    &:hover:not(:disabled) {
      background: rgba(0, 170, 255, 0.3);
      transform: translateX(-2px);
    }

    &:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    &.next:hover {
      transform: translateX(2px);
    }
  }
}
</style>
