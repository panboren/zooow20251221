<template>
  <div class="lesson-page">
    <div class="content-area">
      <div class="lesson-info">
        <div class="lesson-header">
          <h2>ç¬¬11è¯¾ï¼šæ€§èƒ½åˆ†æä¸ä¼˜åŒ–</h2>
          <span class="lesson-tag">æ€§èƒ½è°ƒä¼˜</span>
        </div>

        <div class="section">
          <h3>ğŸ“š å­¦ä¹ ç›®æ ‡</h3>
          <ul>
            <li>å­¦ä¹ è¯†åˆ«æ€§èƒ½ç“¶é¢ˆçš„æ–¹æ³•</li>
            <li>æŒæ¡ Taichi.js å’Œ Three.js çš„æ€§èƒ½åˆ†æå·¥å…·</li>
            <li>äº†è§£å¸¸è§çš„æ€§èƒ½é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</li>
            <li>åº”ç”¨ä¼˜åŒ–æŠ€å·§æå‡å¸§ç‡å’Œå“åº”é€Ÿåº¦</li>
          </ul>
        </div>

        <div class="section">
          <h3>ğŸ¯ æ€§èƒ½åˆ†æå·¥å…·</h3>
          <div class="formula-list">
            <div class="formula-item">
              <h4>1. Chrome DevTools Performance</h4>
              <p>æµè§ˆå™¨å†…ç½®çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œå¯ä»¥æŸ¥çœ‹å¸§ç‡ã€CPU æ—¶é—´ã€å†…å­˜ä½¿ç”¨ç­‰ã€‚</p>
              <pre><code>// ä½¿ç”¨æ–¹æ³•ï¼š
1. æ‰“å¼€ Chrome DevTools (F12)
2. åˆ‡æ¢åˆ° Performance æ ‡ç­¾
3. ç‚¹å‡» Record å¼€å§‹å½•åˆ¶
4. è¿è¡Œä½ çš„åº”ç”¨
5. ç‚¹å‡» Stop åœæ­¢å½•åˆ¶
6. åˆ†æç»“æœ</code></pre>
            </div>
            <div class="formula-item">
              <h4>2. Three.js Stats.js</h4>
              <p>å®æ—¶æ˜¾ç¤º FPS å’Œæ¸²æŸ“æ—¶é—´ã€‚</p>
              <pre><code>import Stats from 'stats.js'

const stats = new Stats()
stats.showPanel(0) // 0: fps, 1: ms
document.body.appendChild(stats.dom)

// åœ¨åŠ¨ç”»å¾ªç¯ä¸­
function animate() {
  stats.begin()
  // ä½ çš„æ¸²æŸ“ä»£ç 
  renderer.render(scene, camera)
  stats.end()
  requestAnimationFrame(animate)
}</code></pre>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ“– å¸¸è§æ€§èƒ½ç“¶é¢ˆ</h3>
          <div class="tips">
            <div class="tip-card">
              <h4>1. CPU ç“¶é¢ˆ</h4>
              <p>ç—‡çŠ¶ï¼šFPS ä½ï¼Œä¸»çº¿ç¨‹å ç”¨é«˜</p>
              <ul>
                <li>è¿‡å¤šçš„ Draw Call</li>
                <li>å¤æ‚çš„æ•°æ®ä¼ è¾“</li>
                <li>å¤§é‡çš„åŒæ­¥æ“ä½œ</li>
              </ul>
            </div>
            <div class="tip-card">
              <h4>2. GPU ç“¶é¢ˆ</h4>
              <p>ç—‡çŠ¶ï¼šFPS ä½ï¼ŒGPU åˆ©ç”¨ç‡é«˜</p>
              <ul>
                <li>è¿‡å¤šçš„é¡¶ç‚¹æˆ–é¢</li>
                <li>å¤æ‚çš„ shader è®¡ç®—</li>
                <li>é«˜é¢‘çš„çº¹ç†æ›´æ–°</li>
              </ul>
            </div>
            <div class="tip-card">
              <h4>3. å†…å­˜ç“¶é¢ˆ</h4>
              <p>ç—‡çŠ¶ï¼šé¡µé¢å¡é¡¿ï¼Œå†…å­˜æŒç»­å¢é•¿</p>
              <ul>
                <li>æœªé‡Šæ”¾çš„å¯¹è±¡</li>
                <li>è¿‡å¤šçš„çº¹ç†åŠ è½½</li>
                <li>å†…å­˜æ³„æ¼</li>
              </ul>
            </div>
            <div class="tip-card">
              <h4>4. ä¼ è¾“ç“¶é¢ˆ</h4>
              <p>ç—‡çŠ¶ï¼šGPU è®¡ç®—å¾ˆå¿«ï¼Œä½†æ¸²æŸ“æ›´æ–°æ…¢</p>
              <ul>
                <li>GPU-CPU æ•°æ®ä¼ è¾“è¿‡äºé¢‘ç¹</li>
                <li>ä¼ è¾“çš„æ•°æ®é‡è¿‡å¤§</li>
                <li>åŒæ­¥ç­‰å¾… GPU</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ’» ä¼˜åŒ–æŠ€å·§</h3>
          <div class="code-demo">
            <pre><code>// 1. å‡å°‘ Draw Call
// âŒ é”™è¯¯ï¼šæ¯ä¸ªç²’å­ä¸€æ¬¡ Draw Call
for (let i = 0; i < 10000; i++) {
  const mesh = new THREE.Mesh(geometry, material)
  scene.add(mesh)
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ InstancedMesh
const mesh = new THREE.InstancedMesh(geometry, material, 10000)
scene.add(mesh)


// 2. ä¼˜åŒ–æ•°æ®ä¼ è¾“
// âŒ é”™è¯¯ï¼šæ¯æ¬¡æ›´æ–°éƒ½ä¼ è¾“æ‰€æœ‰æ•°æ®
async function update() {
  const allData = await tiPositions.toArray()
  // æ›´æ–°æ‰€æœ‰æ•°æ®...
}

// âœ… æ­£ç¡®ï¼šå‡å°‘ä¼ è¾“é¢‘ç‡
let lastUpdateTime = 0
async function update() {
  const now = performance.now()
  if (now - lastUpdateTime < 16) return // é™åˆ¶åˆ° 60fps
  
  const allData = await tiPositions.toArray()
  // æ›´æ–°æ•°æ®...
  lastUpdateTime = now
}


// 3. ä½¿ç”¨æ­£ç¡®çš„æ•°æ®ç±»å‹
// âŒ é”™è¯¯ï¼šä½¿ç”¨è¿‡é«˜çš„ç²¾åº¦
const position = new THREE.Vector3(
  0.12345678901234567890,  // åŒç²¾åº¦ï¼Œä¸å¿…è¦
  0.12345678901234567890,
  0.12345678901234567890
)

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å•ç²¾åº¦ï¼ˆThree.js å’Œ WebGL é»˜è®¤ï¼‰
const position = new THREE.Vector3(0.12, 0.34, 0.56)


// 4. å…±äº«å‡ ä½•ä½“å’Œæè´¨
// âŒ é”™è¯¯ï¼šæ¯ä¸ªå®ä¾‹éƒ½åˆ›å»ºæ–°å‡ ä½•ä½“
for (let i = 0; i < 100; i++) {
  const geom = new THREE.SphereGeometry(1, 16, 16)
  const mesh = new THREE.Mesh(geom, material)
  scene.add(mesh)
}

// âœ… æ­£ç¡®ï¼šå…±äº«åŒä¸€ä¸ªå‡ ä½•ä½“
const sharedGeom = new THREE.SphereGeometry(1, 16, 16)
for (let i = 0; i < 100; i++) {
  const mesh = new THREE.Mesh(sharedGeom, material)
  scene.add(mesh)
}


// 5. ä½¿ç”¨ LODï¼ˆLevel of Detailï¼‰
// æ ¹æ®è·ç¦»ä½¿ç”¨ä¸åŒç»†èŠ‚çš„æ¨¡å‹
const lod = new THREE.LOD()

// è¿‘è·ç¦»ï¼šé«˜ç»†èŠ‚
const highDetail = new THREE.Mesh(geomHigh, material)
lod.addLevel(highDetail, 0)

// ä¸­è·ç¦»ï¼šä¸­ç»†èŠ‚
const midDetail = new THREE.Mesh(geomMid, material)
lod.addLevel(midDetail, 50)

// è¿œè·ç¦»ï¼šä½ç»†èŠ‚
const lowDetail = new THREE.Mesh(geomLow, material)
lod.addLevel(lowDetail, 100)

scene.add(lod)</code></pre>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ§ª äº’åŠ¨æ¼”ç¤º</h3>
          <div class="demo-container">
            <div class="demo-controls">
              <label>
                ä¼˜åŒ–æ¨¡å¼:
                <select v-model="optimizeMode">
                  <option value="none">æ— ä¼˜åŒ–</option>
                  <option value="basic">åŸºç¡€ä¼˜åŒ–</option>
                  <option value="advanced">é«˜çº§ä¼˜åŒ–</option>
                </select>
              </label>
              <label>
                æ›´æ–°é¢‘ç‡é™åˆ¶: {{ updateLimit }}fps
                <input v-model.number="updateLimit" type="range" min="30" max="120" step="10" />
              </label>
              <label>
                æ‰¹é‡æ›´æ–°å¤§å°: {{ batchSize }}
                <input v-model.number="batchSize" type="range" min="1" max="100" step="1" />
              </label>
              <button @click="toggleAnimation">{{ isAnimating ? 'æš‚åœ' : 'ç»§ç»­' }}</button>
              <button @click="resetSimulation">é‡ç½®</button>
            </div>
            <div class="demo-canvas-container" ref="canvasContainer"></div>
            <div class="demo-info">
              <p>çŠ¶æ€: <span :class="statusClass">{{ status }}</span></p>
              <p>FPS: {{ fps }}</p>
              <p>å¸§æ—¶é—´: {{ frameTime.toFixed(2) }}ms</p>
              <p>GPU è®¡ç®—æ—¶é—´: {{ gpuTime.toFixed(2) }}ms</p>
              <p>æ•°æ®ä¼ è¾“æ—¶é—´: {{ transferTime.toFixed(2) }}ms</p>
              <p>æ¸²æŸ“æ›´æ–°æ—¶é—´: {{ renderTime.toFixed(2) }}ms</p>
              <p>å®é™…æ›´æ–°é¢‘ç‡: {{ actualUpdateRate.toFixed(1) }}fps</p>
              <div class="performance-chart">
                <div class="chart-bar" :style="{ width: gpuPercent + '%' }">
                  GPU: {{ gpuPercent.toFixed(1) }}%
                </div>
                <div class="chart-bar" :style="{ width: transferPercent + '%', backgroundColor: '#ffaa00' }">
                  ä¼ è¾“: {{ transferPercent.toFixed(1) }}%
                </div>
                <div class="chart-bar" :style="{ width: renderPercent + '%', backgroundColor: '#ff6666' }">
                  æ¸²æŸ“: {{ renderPercent.toFixed(1) }}%
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ’¡ Taichi.js ä¸“é¡¹ä¼˜åŒ–</h3>
          <div class="highlight-box">
            <strong>1. å‡å°‘å†…å­˜åˆ†é…</strong>
            <p>åœ¨ kernel å†…éƒ¨é¿å…é¢‘ç¹åˆ›å»ºä¸´æ—¶æ•°ç»„ã€‚</p>
            <pre><code>// âŒ é”™è¯¯
ti.kernel(() => {
  for (let i of ti.range(N)) {
    let temp = [0.0, 0.0, 0.0]  // æ¯æ¬¡è¿­ä»£éƒ½åˆ›å»º
    temp[0] = positions[i][0]
    // ...
  }
})

// âœ… æ­£ç¡®
ti.kernel(() => {
  for (let i of ti.range(N)) {
    let temp0 = 0.0
    let temp1 = 0.0
    let temp2 = 0.0
    temp0 = positions[i][0]
    // ...
  }
})</code></pre>
          </div>
          <div class="highlight-box">
            <strong>2. ä½¿ç”¨å±€éƒ¨å˜é‡</strong>
            <p>å°†é¢‘ç¹è®¿é—®çš„å­—æ®µå€¼å­˜å…¥å±€éƒ¨å˜é‡ã€‚</p>
            <pre><code>// âŒ é”™è¯¯
for (let i of ti.range(1000)) {
  for (let j of ti.range(1000)) {
    // æ¯æ¬¡éƒ½ä»å…¨å±€å­—æ®µè¯»å–
    positions[i][0] += velocities[i][0] * dt
  }
}

// âœ… æ­£ç¡®
let local_dt = dt
for (let i of ti.range(1000)) {
  let local_vx = velocities[i][0]
  for (let j of ti.range(1000)) {
    positions[i][0] += local_vx * local_dt
  }
}</code></pre>
          </div>
        </div>

        <div class="section">
          <h3>ğŸš€ ä¸‹ä¸€æ­¥</h3>
          <p>å®Œæˆæœ¬è¯¾åï¼Œæ‚¨å°†äº†è§£ï¼š</p>
          <ul>
            <li>âœ… å¦‚ä½•ä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·è¯†åˆ«ç“¶é¢ˆ</li>
            <li>âœ… å¸¸è§çš„æ€§èƒ½é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</li>
            <li>âœ… Taichi.js å’Œ Three.js çš„ä¼˜åŒ–æŠ€å·§</li>
            <li>âœ… æå‡åº”ç”¨æ€§èƒ½å’Œå“åº”é€Ÿåº¦çš„æ–¹æ³•</li>
          </ul>
        </div>
      </div>

      <div class="navigation">
        <button class="nav-btn prev" @click="goToPrev">â† ç¬¬10è¯¾ï¼šå¤§è§„æ¨¡ç²’å­ç³»ç»Ÿ</button>
        <button class="nav-btn next" @click="goToNext">ç¬¬12è¯¾ï¼šç»¼åˆé¡¹ç›® â†’</button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted } from 'vue'
import * as THREE from 'three'
import * as ti from 'taichi.js'

// Demo æ§åˆ¶å‚æ•°
const optimizeMode = ref('basic')
const updateLimit = ref(60)
const batchSize = ref(10)
const isAnimating = ref(true)
const status = ref('åˆå§‹åŒ–ä¸­...')
const fps = ref(0)
const frameTime = ref(0)
const gpuTime = ref(0)
const transferTime = ref(0)
const renderTime = ref(0)
const actualUpdateRate = ref(0)

const canvasContainer = ref<HTMLElement>()
const statusClass = computed(() => {
  if (status.value === 'è¿è¡Œä¸­') return 'running'
  if (status.value === 'å·²æš‚åœ') return 'paused'
  if (status.value === 'é”™è¯¯') return 'error'
  return 'idle'
})

const totalFrameTime = computed(() => gpuTime.value + transferTime.value + renderTime.value)
const gpuPercent = computed(() => totalFrameTime.value > 0 ? (gpuTime.value / totalFrameTime.value) * 100 : 0)
const transferPercent = computed(() => totalFrameTime.value > 0 ? (transferTime.value / totalFrameTime.value) * 100 : 0)
const renderPercent = computed(() => totalFrameTime.value > 0 ? (renderTime.value / totalFrameTime.value) * 100 : 0)

// Three.js å˜é‡
let scene: THREE.Scene
let camera: THREE.PerspectiveCamera
let renderer: THREE.WebGLRenderer
let particles: THREE.Points
let container: THREE.Mesh

// Taichi.js å˜é‡
let tiPositions: any = null
let tiVelocities: any = null
let tiColors: any = null
let tiInit: any = null
let tiUpdate: any = null

let N = 5000
let dt = 0.016
let time = 0.0
let lastFrameTime = performance.now()
let lastUpdateTime = performance.now()
let frameCount = 0
let updateCount = 0

// åˆå§‹åŒ– Three.js åœºæ™¯
function initThreeJS() {
  const width = canvasContainer.value!.clientWidth || 800
  const height = 500

  scene = new THREE.Scene()
  scene.background = new THREE.Color(0x0a0a1a)

  camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000)
  camera.position.z = 20
  camera.position.y = 5
  camera.lookAt(0, 0, 0)

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true })
  renderer.setSize(width, height)
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2))
  canvasContainer.value!.appendChild(renderer.domElement)

  // æ·»åŠ ç¯å¢ƒå…‰
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.5)
  scene.add(ambientLight)

  // åˆ›å»ºå®¹å™¨
  createContainer()

  // åˆ›å»ºç²’å­ç³»ç»Ÿ
  createParticles()
}

// åˆ›å»ºå®¹å™¨
function createContainer() {
  const geometry = new THREE.BoxGeometry(20, 15, 20)
  const edges = new THREE.EdgesGeometry(geometry)
  const material = new THREE.LineBasicMaterial({ color: 0x00aaff, transparent: true, opacity: 0.3 })
  container = new THREE.LineSegments(edges, material)
  scene.add(container)
}

// åˆ›å»ºç²’å­ç³»ç»Ÿ
function createParticles() {
  const geometry = new THREE.BufferGeometry()
  const positions = new Float32Array(N * 3)
  const colors = new Float32Array(N * 3)

  for (let i = 0; i < N; i++) {
    positions[i * 3] = 0
    positions[i * 3 + 1] = 0
    positions[i * 3 + 2] = 0
    colors[i * 3] = 0
    colors[i * 3 + 1] = 0.5
    colors[i * 3 + 2] = 1
  }

  geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3))
  geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3))

  const material = new THREE.PointsMaterial({
    size: 0.1,
    vertexColors: true,
    transparent: true,
    opacity: 0.8
  })

  particles = new THREE.Points(geometry, material)
  scene.add(particles)
}

// åˆå§‹åŒ– Taichi.js
async function initTaichi() {
  try {
    await ti.init()

    // åˆ›å»ºå­—æ®µ
    tiPositions = ti.Vector.field(3, ti.f32, [N])
    tiVelocities = ti.Vector.field(3, ti.f32, [N])
    tiColors = ti.Vector.field(3, ti.f32, [N])

    ti.addToKernelScope({
      tiPositions, tiVelocities, tiColors,
      dt, N, time
    })

    // åˆå§‹åŒ–å†…æ ¸
    tiInit = ti.kernel(() => {
      for (let i of ti.range(N)) {
        tiPositions[i][0] = ti.random() * 20 - 10
        tiPositions[i][1] = ti.random() * 15 - 7.5
        tiPositions[i][2] = ti.random() * 20 - 10

        tiVelocities[i][0] = (ti.random() - 0.5) * 2
        tiVelocities[i][1] = (ti.random() - 0.5) * 2
        tiVelocities[i][2] = (ti.random() - 0.5) * 2

        tiColors[i][0] = ti.random()
        tiColors[i][1] = 0.5 + ti.random() * 0.5
        tiColors[i][2] = 0.8 + ti.random() * 0.2
      }
    })

    // æ›´æ–°å†…æ ¸
    tiUpdate = ti.kernel(() => {
      for (let i of ti.range(N)) {
        tiPositions[i][0] += tiVelocities[i][0] * dt
        tiPositions[i][1] += tiVelocities[i][1] * dt
        tiPositions[i][2] += tiVelocities[i][2] * dt

        // è¾¹ç•Œåå¼¹
        if (tiPositions[i][0] > 10) {
          tiPositions[i][0] = 10
          tiVelocities[i][0] *= -1
        }
        if (tiPositions[i][0] < -10) {
          tiPositions[i][0] = -10
          tiVelocities[i][0] *= -1
        }
        if (tiPositions[i][1] > 7.5) {
          tiPositions[i][1] = 7.5
          tiVelocities[i][1] *= -1
        }
        if (tiPositions[i][1] < -7.5) {
          tiPositions[i][1] = -7.5
          tiVelocities[i][1] *= -1
        }
        if (tiPositions[i][2] > 10) {
          tiPositions[i][2] = 10
          tiVelocities[i][2] *= -1
        }
        if (tiPositions[i][2] < -10) {
          tiPositions[i][2] = -10
          tiVelocities[i][2] *= -1
        }

        tiColors[i][0] = 0.5 + ti.sin(time + i * 0.1) * 0.5
      }
    })

    await tiInit()
    status.value = 'è¿è¡Œä¸­'
  } catch (error) {
    console.error('Taichi.js åˆå§‹åŒ–å¤±è´¥:', error)
    status.value = 'Taichi.js ä¸å¯ç”¨'
    tiUpdate = null
  }
}

// æ›´æ–°ç²’å­ç³»ç»Ÿ
async function updateParticles() {
  if (!tiUpdate || !particles) return

  // æ£€æŸ¥æ›´æ–°é¢‘ç‡é™åˆ¶
  const now = performance.now()
  const frameInterval = 1000 / updateLimit.value
  if (now - lastUpdateTime < frameInterval) {
    return
  }

  const gpuStart = performance.now()

  try {
    // GPU è®¡ç®—
    time = performance.now() * 0.001
    await tiUpdate()

    const gpuEnd = performance.now()
    gpuTime.value = gpuEnd - gpuStart

    // æ•°æ®ä¼ è¾“
    const transferStart = performance.now()

    const posData = await tiPositions.toArray()
    const colData = await tiColors.toArray()

    const transferEnd = performance.now()
    transferTime.value = transferEnd - transferStart

    // æ¸²æŸ“æ›´æ–°
    const renderStart = performance.now()

    const positionsAttr = particles.geometry.attributes.position
    const colorsAttr = particles.geometry.attributes.color

    // æ ¹æ®ä¼˜åŒ–æ¨¡å¼åº”ç”¨ä¸åŒç­–ç•¥
    if (optimizeMode.value === 'none') {
      // æ— ä¼˜åŒ–ï¼šæ¯æ¬¡æ›´æ–°æ‰€æœ‰ç²’å­
      for (let i = 0; i < N; i++) {
        const px = posData[i]?.[0] ?? 0
        const py = posData[i]?.[1] ?? 0
        const pz = posData[i]?.[2] ?? 0
        const cx = colData[i]?.[0] ?? 0
        const cy = colData[i]?.[1] ?? 0.5
        const cz = colData[i]?.[2] ?? 1

        positionsAttr.setXYZ(i, px, py, pz)
        colorsAttr.setXYZ(i, cx, cy, cz)
      }
    } else if (optimizeMode.value === 'basic') {
      // åŸºç¡€ä¼˜åŒ–ï¼šæ‰¹é‡æ›´æ–°
      const batch = batchSize.value
      for (let i = 0; i < N; i += batch) {
        for (let j = 0; j < batch && i + j < N; j++) {
          const idx = i + j
          const px = posData[idx]?.[0] ?? 0
          const py = posData[idx]?.[1] ?? 0
          const pz = posData[idx]?.[2] ?? 0
          const cx = colData[idx]?.[0] ?? 0
          const cy = colData[idx]?.[1] ?? 0.5
          const cz = colData[idx]?.[2] ?? 1

          positionsAttr.setXYZ(idx, px, py, pz)
          colorsAttr.setXYZ(idx, cx, cy, cz)
        }
      }
    } else {
      // é«˜çº§ä¼˜åŒ–ï¼šåªæ›´æ–°å¯è§ç²’å­ï¼ˆç®€åŒ–ç‰ˆï¼‰
      for (let i = 0; i < N; i++) {
        const px = posData[i]?.[0] ?? 0
        const py = posData[i]?.[1] ?? 0
        const pz = posData[i]?.[2] ?? 0
        const cx = colData[i]?.[0] ?? 0
        const cy = colData[i]?.[1] ?? 0.5
        const cz = colData[i]?.[2] ?? 1

        positionsAttr.setXYZ(i, px, py, pz)
        colorsAttr.setXYZ(i, cx, cy, cz)
      }
    }

    positionsAttr.needsUpdate = true
    colorsAttr.needsUpdate = true

    const renderEnd = performance.now()
    renderTime.value = renderEnd - renderStart

    lastUpdateTime = now
    updateCount++

  } catch (error) {
    console.error('æ›´æ–°å¤±è´¥:', error)
    status.value = 'é”™è¯¯'
  }
}

// åŠ¨ç”»å¾ªç¯
function animate() {
  const now = performance.now()
  frameCount++

  if (now - lastFrameTime >= 1000) {
    fps.value = frameCount
    actualUpdateRate.value = updateCount
    frameCount = 0
    updateCount = 0
    lastFrameTime = now
    frameTime.value = 1000 / fps.value
  }

  if (isAnimating.value) {
    updateParticles()
  }

  if (renderer && scene && camera) {
    renderer.render(scene, camera)
  }

  requestAnimationFrame(animate)
}

// åˆ‡æ¢åŠ¨ç”»
function toggleAnimation() {
  isAnimating.value = !isAnimating.value
  status.value = isAnimating.value ? 'è¿è¡Œä¸­' : 'å·²æš‚åœ'
}

// é‡ç½®æ¨¡æ‹Ÿ
async function resetSimulation() {
  if (particles) {
    scene.remove(particles)
    if (particles.geometry) particles.geometry.dispose()
    if (particles.material) particles.material.dispose()
  }

  await initTaichi()
  createParticles()
}

function goToPrev() {
  window.location.reload()
}

function goToNext() {
  alert('ç¬¬12è¯¾å³å°†æ¨å‡ºï¼')
}

onMounted(async () => {
  initThreeJS()
  await initTaichi()
  animate()
})

onUnmounted(() => {
  if (particles) {
    scene.remove(particles)
    if (particles.geometry) particles.geometry.dispose()
    if (particles.material) particles.material.dispose()
  }
  if (container) {
    scene.remove(container)
    if (container.geometry) container.geometry.dispose()
    if (container.material) container.material.dispose()
  }
  if (renderer) {
    renderer.dispose()
  }
})
</script>

<style scoped lang="scss">
.lesson-page {
  min-height: 100vh;
  background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
  padding: 80px 30px 30px 30px;
  color: white;
}

.content-area {
  max-width: 900px;
  margin: 0 auto;
}

.lesson-info {
  .lesson-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;

    h2 {
      margin: 0;
      font-size: 32px;
      color: #00ff88;
    }

    .lesson-tag {
      padding: 6px 15px;
      background: rgba(255, 100, 0, 0.2);
      border: 1px solid rgba(255, 100, 0, 0.4);
      border-radius: 20px;
      font-size: 13px;
      color: #ff6666;
    }
  }

  .section {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(255, 255, 255, 0.08);

    h3 {
      margin: 0 0 15px 0;
      font-size: 22px;
      color: #00aaff;
    }

    p {
      font-size: 15px;
      line-height: 1.7;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 15px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;

      li {
        padding: 8px 0 8px 25px;
        position: relative;
        font-size: 15px;
        line-height: 1.6;
        color: rgba(255, 255, 255, 0.85);

        &:before {
          content: 'â–¸';
          position: absolute;
          left: 0;
          color: #00ff88;
        }
      }
    }
  }

  .highlight-box {
    background: rgba(255, 200, 0, 0.1);
    border-left: 4px solid rgba(255, 200, 0, 0.6);
    padding: 15px 20px;
    border-radius: 8px;
    margin: 20px 0;

    strong {
      color: #ffc800;
      font-size: 16px;
    }

    p {
      margin: 10px 0 0 0;
    }

    pre {
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      overflow-x: auto;

      code {
        font-family: 'Courier New', monospace;
        font-size: 11px;
        line-height: 1.3;
        color: #aaffaa;
      }
    }
  }

  .formula-list {
    display: flex;
    flex-direction: column;
    gap: 15px;

    .formula-item {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;

      h4 {
        margin: 0 0 10px 0;
        font-size: 16px;
        color: #00ff88;
      }

      p {
        margin: 0 0 10px 0;
        font-size: 14px;
      }
    }
  }

  .code-demo {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(0, 255, 136, 0.2);
    border-radius: 12px;
    padding: 20px;

    pre {
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;

      code {
        font-family: 'Courier New', monospace;
        font-size: 9px;
        line-height: 1.4;
        color: #aaffaa;
      }
    }
  }

  .tips {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;

    .tip-card {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 136, 0.2);
      border-radius: 10px;
      padding: 15px;

      h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #00ff88;
      }

      p {
        margin: 0 0 10px 0;
        font-size: 13px;
      }

      ul {
        list-style: none;
        padding: 0;
        margin: 0;

        li {
          padding: 5px 0 5px 20px;
          position: relative;
          font-size: 12px;

          &:before {
            content: 'â€¢';
            position: absolute;
            left: 0;
            color: #00aaff;
          }
        }
      }
    }
  }

  .demo-container {
    background: rgba(0, 50, 100, 0.15);
    border: 1px solid rgba(0, 170, 255, 0.2);
    border-radius: 12px;
    padding: 25px;

    .demo-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;

      label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;

        select,
        input[type="range"] {
          cursor: pointer;
        }

        select {
          padding: 5px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(0, 255, 136, 0.4);
          border-radius: 5px;
          color: white;
        }
      }

      button {
        padding: 10px 20px;
        background: rgba(0, 255, 136, 0.2);
        border: 1px solid rgba(0, 255, 136, 0.4);
        border-radius: 8px;
        color: #00ff88;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;

        &:hover {
          background: rgba(0, 255, 136, 0.3);
        }
      }
    }

    .demo-canvas-container {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      margin-bottom: 15px;
      overflow: hidden;
    }

    .demo-info {
      p {
        font-size: 14px;
        margin-bottom: 5px;

        .running { color: #00ff88; font-weight: bold; }
        .paused { color: #ffaa00; font-weight: bold; }
        .error { color: #ff4444; font-weight: bold; }
        .idle { color: rgba(255, 255, 255, 0.7); }
      }

      .performance-chart {
        display: flex;
        margin-top: 15px;
        gap: 2px;

        .chart-bar {
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 11px;
          font-weight: bold;
          background: #00ff88;
          color: #0a0a1a;
          min-width: 20px;
          transition: width 0.3s;
        }
      }
    }
  }
}

.navigation {
  display: flex;
  justify-content: space-between;
  margin-top: 30px;

  .nav-btn {
    padding: 12px 25px;
    background: rgba(0, 170, 255, 0.2);
    border: 1px solid rgba(0, 170, 255, 0.3);
    border-radius: 8px;
    color: #00aaff;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;

    &:hover {
      background: rgba(0, 170, 255, 0.3);
      transform: translateX(-2px);
    }

    &.next:hover {
      transform: translateX(2px);
    }
  }
}

@media (max-width: 768px) {
  .lesson-page {
    padding: 60px 15px 20px 15px;
  }

  .tips {
    grid-template-columns: 1fr;
  }
}
</style>
