# taichi.js å®Œæ•´çŸ¥è¯†ç‚¹æ€»ç»“

## ğŸ“š ä¸€ã€taichi.js ç®€ä»‹

taichi.js æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ GPU å¹¶è¡Œè®¡ç®—åº“ï¼ŒåŸºäº TypeScript/JavaScriptï¼Œä½¿ç”¨ WebGPU åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ GPU åŠ é€Ÿè®¡ç®—ã€‚

### ç‰¹ç‚¹
- ğŸš€ GPU å¹¶è¡Œè®¡ç®—
- ğŸŒ æµè§ˆå™¨åŸç”Ÿè¿è¡Œï¼ˆæ— éœ€åç«¯ï¼‰
- ğŸ“ Python/TypeScript å‹å¥½è¯­æ³•
- ğŸ¨ æ”¯æŒå›¾å½¢æ¸²æŸ“å’Œç§‘å­¦è®¡ç®—

---

## ğŸ”§ äºŒã€å®‰è£…ä¸åˆå§‹åŒ–

### 2.1 å®‰è£…

```bash
npm install taichi.js
```

### 2.2 åŠ è½½ taichi.js

```typescript
// Nuxt æ’ä»¶æ–¹å¼ï¼ˆæ¨èï¼‰
const { $loadTaichi } = useNuxtApp()
const ti = await $loadTaichi()

// æˆ–ç›´æ¥å¯¼å…¥
import * as ti from 'taichi.js'
```

### 2.3 åˆå§‹åŒ– WebGPU

```typescript
await ti.init()
```

### 2.4 æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ

- Chrome 113+
- Edge 113+
- Firefox Nightly
- Safari Technology Preview

---

## ğŸ—„ï¸ ä¸‰ã€Fieldï¼ˆå­—æ®µï¼‰- æ ¸å¿ƒæ•°æ®ç»“æ„

### 3.1 ä»€ä¹ˆæ˜¯ Fieldï¼Ÿ
Field æ˜¯ taichi.js çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œç±»ä¼¼äºæ•°ç»„ï¼Œä½†åœ¨ GPU ä¸Šå­˜å‚¨å’Œè®¿é—®ã€‚

### 3.2 åˆ›å»ºæ ‡é‡ Field

```typescript
// ä¸€ç»´æ•°ç»„
const arr = ti.field(ti.i32, [100])

// äºŒç»´æ•°ç»„
const matrix = ti.field(ti.f32, [512, 512])

// ä¸‰ç»´æ•°ç»„
const volume = ti.field(ti.f32, [100, 100, 100])
```

### 3.3 åˆ›å»ºå‘é‡ Field

```typescript
// å­˜å‚¨é¢œè‰² (RGBA 4åˆ†é‡)
const pixels = ti.Vector.field(4, ti.f32, [512, 512])

// å­˜å‚¨åæ ‡ (XY 2åˆ†é‡)
const positions = ti.Vector.field(2, ti.f32, [1000])

// å­˜å‚¨å‘é‡ (XYZ 3åˆ†é‡)
const vectors = ti.Vector.field(3, ti.f32, [100])
```

### 3.4 åˆ›å»ºçŸ©é˜µ Field

```typescript
// 2x2 çŸ©é˜µ
const matrices = ti.Matrix.field(2, 2, ti.f32, [100])

// 3x3 çŸ©é˜µ
const transforms = ti.Matrix.field(3, 3, ti.f32, [50])
```

### 3.5 æ•°æ®ç±»å‹

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `ti.i32` | 32ä½æ•´æ•° | `ti.field(ti.i32, [100])` |
| `ti.f32` | 32ä½æµ®ç‚¹æ•° | `ti.field(ti.f32, [100])` |
| `ti.i64` | 64ä½æ•´æ•° | `ti.field(ti.i64, [100])` |
| `ti.f64` | 64ä½æµ®ç‚¹æ•° | `ti.field(ti.f64, [100])` |

---

## âš¡ å››ã€Kernelï¼ˆå†…æ ¸ï¼‰- GPU å¹¶è¡Œä»£ç 

### 4.1 ä»€ä¹ˆæ˜¯ Kernelï¼Ÿ
Kernel æ˜¯åœ¨ GPU ä¸Šå¹¶è¡Œæ‰§è¡Œçš„å‡½æ•°ï¼Œå¯ä»¥åŒæ—¶å¤„ç†å¤§é‡æ•°æ®ã€‚

### 4.2 åˆ›å»º Kernel

```typescript
// åŸºæœ¬è¯­æ³•
const kernel = ti.kernel(function k() {
  // GPU å¹¶è¡Œä»£ç 
})

// å‘½åå‡½æ•°ï¼ˆæ¨èï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
const kernel = ti.kernel(function fillArray() {
  for (let i of range(100)) {
    arr[i] = i * 2
  }
})
```

### 4.3 range() å‡½æ•°

`range()` åªèƒ½åœ¨ kernel å†…éƒ¨ä½¿ç”¨ï¼Œç”Ÿæˆæ•°å­—åºåˆ—ã€‚

```typescript
// ä» 0 åˆ° n-1
for (let i of range(100)) {
  // i = 0, 1, 2, ..., 99
}

// ä» start åˆ° end-1ï¼ˆå¦‚æœæ”¯æŒï¼‰
for (let i of range(10, 20)) {
  // i = 10, 11, 12, ..., 19
}

// åµŒå¥—å¾ªç¯ï¼ˆäºŒç»´æ•°ç»„ï¼‰
for (let i of range(512)) {
  for (let j of range(512)) {
    // éå† 512x512 çš„æ‰€æœ‰åƒç´ 
  }
}
```

### 4.4 è®¿é—® Field

```typescript
// æ ‡é‡ Field
arr[i] = 42
matrix[[i, j]] = 3.14
volume[[x, y, z]] = 1.0

// å‘é‡ Field
pixels[[i, j]] = [r, g, b, a]  // è®¾ç½®æ•´ä¸ªå‘é‡
positions[i] = [x, y]

// çŸ©é˜µ Field
matrices[i] = [[1, 2], [3, 4]]
```

---

## ğŸ”— äº”ã€addToKernelScope - å†…æ ¸ä½œç”¨åŸŸ

### 5.1 ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ
Kernel å‡½æ•°éœ€è¦çŸ¥é“å¯ä»¥è®¿é—®å“ªäº› Fieldã€‚

### 5.2 ä½¿ç”¨æ–¹æ³•

```typescript
// åˆ›å»º Field
const arr = ti.field(ti.i32, [100])
const pixels = ti.Vector.field(4, ti.f32, [512, 512])

// æ·»åŠ åˆ°å†…æ ¸ä½œç”¨åŸŸï¼ˆå¿…é¡»åœ¨å®šä¹‰ kernel ä¹‹å‰ï¼‰
ti.addToKernelScope({ arr, pixels })

// ç°åœ¨å¯ä»¥åœ¨ kernel ä¸­ä½¿ç”¨äº†
const kernel = ti.kernel(function k() {
  for (let i of range(100)) {
    arr[i] = i  // âœ… å¯ä»¥è®¿é—®
  }
  
  for (let i of range(512)) {
    for (let j of range(512)) {
      pixels[[i, j]] = [i/512, j/512, 0, 1]  // âœ… å¯ä»¥è®¿é—®
    }
  }
})
```

### 5.3 å¸¸è§é”™è¯¯

```typescript
// âŒ é”™è¯¯ï¼šå¿˜è®°æ·»åŠ åˆ°ä½œç”¨åŸŸ
const arr = ti.field(ti.i32, [100])
const kernel = ti.kernel(function k() {
  arr[i] = i  // é”™è¯¯ï¼šunresolved identifier: arr
})

// âœ… æ­£ç¡®
const arr = ti.field(ti.i32, [100])
ti.addToKernelScope({ arr })  // å…³é”®æ­¥éª¤ï¼
const kernel = ti.kernel(function k() {
  arr[i] = i  // âœ… æ­£ç¡®
})
```

---

## ğŸ¨ å…­ã€Canvas æ¸²æŸ“

### 6.1 åˆ›å»º Canvas

```typescript
// HTML
<canvas ref="canvasEl" width="512" height="512"></canvas>

// JavaScript
const tiCanvas = new ti.Canvas(canvasEl.value)
```

### 6.2 æ˜¾ç¤ºå›¾åƒ

```typescript
// æ˜¾ç¤º Field åˆ° Canvas
await tiCanvas.setImage(pixels)
```

### 6.3 æ³¨æ„äº‹é¡¹

- **Field æ ¼å¼**ï¼šå¿…é¡»æ˜¯äºŒç»´çš„ Vector field
- **å‘é‡ç»´åº¦**ï¼šé€šå¸¸æ˜¯ 4 (RGBA) æˆ– 3 (RGB)
- **æ•°æ®èŒƒå›´**ï¼šé¢œè‰²å€¼å¿…é¡»æ˜¯ 0.0-1.0 çš„æµ®ç‚¹æ•°

```typescript
// âœ… æ­£ç¡®æ ¼å¼
const pixels = ti.Vector.field(4, ti.f32, [512, 512])

// âŒ é”™è¯¯æ ¼å¼
const pixels = ti.field(ti.f32, [512, 512, 4])  // ä¸‰ç»´çš„æ— æ³•æ¸²æŸ“
```

---

## ğŸ› ä¸ƒã€è°ƒè¯•æŠ€å·§

### 7.1 ä¸èƒ½åœ¨ Kernel ä¸­ä½¿ç”¨çš„

```typescript
const kernel = ti.kernel(function k() {
  debugger  // âŒ ä¸æ”¯æŒ
  console.log(i)  // âŒ ä¸æ”¯æŒ
  alert(i)  // âŒ ä¸æ”¯æŒ
})
```

### 7.2 è°ƒè¯•æ–¹æ³• 1ï¼šç‰¹æ®Šå€¼æ ‡è®°

```typescript
const kernel = ti.kernel(function k() {
  for (let i of range(100)) {
    if (i === 50) {
      arr[i] = 9999  // ç”¨ç‰¹æ®Šå€¼æ ‡è®°
    } else {
      arr[i] = i
    }
  }
})

kernel()
const result = await arr.toArray1D()
console.log('arr[50] =', result[50])  // åº”è¯¥æ˜¯ 9999
```

### 7.3 è°ƒè¯•æ–¹æ³• 2ï¼šè°ƒè¯• Field

```typescript
const arr = ti.field(ti.i32, [100])
const debugLog = ti.field(ti.i32, [10])
ti.addToKernelScope({ arr, debugLog })

const kernel = ti.kernel(function k() {
  for (let i of range(100)) {
    arr[i] = i * 2
    
    if (i < 10) {
      debugLog[i] = i  // è®°å½•å…³é”®ç‚¹
    }
  }
})

kernel()
const logs = await debugLog.toArray1D()
console.log('è°ƒè¯•ä¿¡æ¯:', logs)
```

### 7.4 è°ƒè¯•æ–¹æ³• 3ï¼šé¢œè‰²å¯è§†åŒ–

```typescript
const kernel = ti.kernel(function k() {
  for (let i of range(512)) {
    for (let j of range(512)) {
      let value = i * j
      
      if (value < 10000) {
        pixels[[i, j]] = [1, 0, 0, 1]  // çº¢è‰²ï¼šå°å€¼
      } else if (value < 20000) {
        pixels[[i, j]] = [0, 1, 0, 1]  // ç»¿è‰²ï¼šä¸­å€¼
      } else {
        pixels[[i, j]] = [0, 0, 1, 1]  // è“è‰²ï¼šå¤§å€¼
      }
    }
  }
})
```

### 7.5 è¯»å–æ•°æ®åˆ°ä¸»æœº

```typescript
// è¯»å–æ•´ä¸ªæ•°ç»„
const data = await arr.toArray1D()

// è¯»å–ç‰¹å®šå…ƒç´ 
const value = await arr.get([10])
console.log('arr[10] =', value)
```

---

## ğŸ¯ å…«ã€å®Œæ•´ç¤ºä¾‹

### 8.1 åŸºç¡€ç¤ºä¾‹ï¼šæ¸å˜å›¾åƒ

```typescript
import { ref } from 'vue'

const { $loadTaichi } = useNuxtApp()
const canvasEl = ref<HTMLCanvasElement | null>(null)

async function runDemo() {
  // 1. åŠ è½½ taichi.js
  const ti = await $loadTaichi()
  
  // 2. åˆå§‹åŒ– WebGPU
  await ti.init()
  
  // 3. åˆ›å»º Field
  const pixels = ti.Vector.field(4, ti.f32, [512, 512])
  
  // 4. æ·»åŠ åˆ°å†…æ ¸ä½œç”¨åŸŸ
  ti.addToKernelScope({ pixels })
  
  // 5. åˆ›å»º Kernel
  const kernel = ti.kernel(function k() {
    for (let i of range(512)) {
      for (let j of range(512)) {
        const r = i / 511.0
        const g = j / 511.0
        const b = 0.5
        const a = 1.0
        
        pixels[[i, j]] = [r, g, b, a]
      }
    }
  })
  
  // 6. æ‰§è¡Œ Kernel
  kernel()
  
  // 7. æ˜¾ç¤ºåˆ° Canvas
  const tiCanvas = new ti.Canvas(canvasEl.value)
  await tiCanvas.setImage(pixels)
}
```

### 8.2 çº¢ç»¿æ¸å˜

```typescript
const kernel = ti.kernel(function k() {
  for (let i of range(512)) {
    for (let j of range(512)) {
      // ä»çº¢è‰²æ¸å˜åˆ°ç»¿è‰²
      const r = 1.0 - (i / 511.0)  // çº¢: 1 â†’ 0
      const g = i / 511.0          // ç»¿: 0 â†’ 1
      
      pixels[[i, j]] = [r, g, 0, 1]
    }
  }
})
```

### 8.3 ä½¿ç”¨ RGB å€¼ï¼ˆ0-255 è½¬ 0-1ï¼‰

```typescript
// è¾…åŠ©å‡½æ•°ï¼ˆåœ¨æ™®é€š JS ä¸­ï¼‰
function rgba(r: number, g: number, b: number, a: number = 255) {
  return [r/255, g/255, b/255, a/255]
}

// åœ¨ Kernel ä¸­ç›´æ¥ä½¿ç”¨å½’ä¸€åŒ–å€¼
const kernel = ti.kernel(function k() {
  for (let i of range(512)) {
    for (let j of range(512)) {
      pixels[[i, j]] = [16/255, 231/255, 19/255, 1]
    }
  }
})
```

---

## âš ï¸ ä¹ã€å¸¸è§é”™è¯¯ä¸è§£å†³

### 9.1 unresolved identifier

```typescript
// âŒ é”™è¯¯
const arr = ti.field(ti.i32, [100])
const kernel = ti.kernel(function k() {
  arr[i] = i  // unresolved identifier: arr
})

// âœ… è§£å†³
ti.addToKernelScope({ arr })  // æ·»åŠ åˆ°ä½œç”¨åŸŸ
```

### 9.2 Invalid argument type annotations

```typescript
// âŒ é”™è¯¯ï¼šå‚æ•°ä¼ é€’æ–¹å¼ä¸å¯¹
const kernel = ti.kernel({ arr }, ({ arr }) => { ... })

// âœ… è§£å†³ï¼šä½¿ç”¨ addToKernelScope
ti.addToKernelScope({ arr })
const kernel = ti.kernel(function k() { ... })
```

### 9.3 é¢œè‰²å€¼èŒƒå›´é”™è¯¯

```typescript
// âŒ é”™è¯¯ï¼šä½¿ç”¨ 0-255 çš„å€¼
pixels[[i, j]] = [255, 0, 0, 255]

// âœ… è§£å†³ï¼šä½¿ç”¨ 0-1 çš„å½’ä¸€åŒ–å€¼
pixels[[i, j]] = [1.0, 0, 0, 1.0]
```

### 9.4 Field æ ¼å¼é”™è¯¯

```typescript
// âŒ é”™è¯¯ï¼šä¸‰ç»´æ•°ç»„æ— æ³•ç”¨äº setImage
const pixels = ti.field(ti.f32, [512, 512, 4])

// âœ… è§£å†³ï¼šäºŒç»´å‘é‡ Field
const pixels = ti.Vector.field(4, ti.f32, [512, 512])
```

---

## ğŸ“Š åã€æ€§èƒ½ä¼˜åŒ–

### 10.1 å¹¶è¡Œæ‰§è¡Œ
taichi.js è‡ªåŠ¨å°† range å¾ªç¯å¹¶è¡ŒåŒ–åˆ° GPU ä¸Šã€‚

### 10.2 å†…å­˜è®¿é—®æ¨¡å¼
å°½é‡ä½¿ç”¨è¿ç»­å†…å­˜è®¿é—®æ¨¡å¼ä»¥æé«˜ç¼“å­˜å‘½ä¸­ç‡ã€‚

### 10.3 é¿å…æ¡ä»¶åˆ†æ”¯
åœ¨å¹¶è¡Œä»£ç ä¸­ï¼Œè¿‡å¤šçš„ if-else åˆ†æ”¯ä¼šå½±å“æ€§èƒ½ã€‚

---

## ğŸ”— åä¸€ã€API å‚è€ƒ

### 11.1 åˆå§‹åŒ–
```typescript
ti.init(options?)
```

### 11.2 åˆ›å»º Field
```typescript
ti.field(type, dimensions)
ti.Vector.field(n, type, dimensions)
ti.Matrix.field(m, n, type, dimensions)
```

### 11.3 Kernel
```typescript
ti.kernel(function k() { ... })
ti.classKernel(this, args, function k(args) { ... })
```

### 11.4 ä½œç”¨åŸŸ
```typescript
ti.addToKernelScope({ var1, var2, ... })
```

### 11.5 Canvas
```typescript
new ti.Canvas(htmlCanvas)
tiCanvas.setImage(field)
```

### 11.6 æ•°æ®ä¼ è¾“
```typescript
field.toArray1D()
field.toArray2D()
field.get(indices)
field.fromArray(array)
```

---

## ğŸ“ åäºŒã€å­¦ä¹ è·¯å¾„å»ºè®®

### åˆçº§
1. âœ… å®‰è£…å’Œåˆå§‹åŒ–
2. âœ… åˆ›å»ºç®€å• Field
3. âœ… ç¼–å†™åŸºç¡€ Kernel
4. âœ… ä½¿ç”¨ range å¾ªç¯
5. âœ… æ˜¾ç¤ºåˆ° Canvas

### ä¸­çº§
1. âœ… å‘é‡å’ŒçŸ©é˜µæ“ä½œ
2. âœ… åµŒå¥—å¾ªç¯
3. âœ… æ¡ä»¶è¯­å¥
4. âœ… æ•°å­¦å‡½æ•°
5. âœ… è°ƒè¯•æŠ€å·§

### é«˜çº§
1. âœ… å¤šä¸ª kernel åä½œ
2. âœ… çº¹ç†æ“ä½œ
3. âœ… 3D æ¸²æŸ“
4. âœ… æ€§èƒ½ä¼˜åŒ–
5. âœ… å®é™…é¡¹ç›®åº”ç”¨

---

è¿™å°±æ˜¯ taichi.js çš„å®Œæ•´çŸ¥è¯†ç‚¹æ€»ç»“ï¼è®°ä½è¿™äº›æ ¸å¿ƒæ¦‚å¿µï¼Œä½ å°±å¯ä»¥å¼€å§‹ä½¿ç”¨ taichi.js è¿›è¡Œ GPU åŠ é€Ÿè®¡ç®—äº†ï¼ğŸš€
